<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Kafka Messages</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        .message { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #f8f8f8; }
        .timestamp { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        .msg-body { white-space: pre-wrap; }
        #messagesContainer { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px; background: #fafafa; }
        #status { margin-top: 10px; font-style: italic; color: green; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #clearBtn { margin-left: 10px; background: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        #clearBtn:hover { background: #d32f2f; }
    </style>
</head>
<body>
<h2>Kafka Messages (Live)</h2>

<form id="messageForm">
    <input type="text" id="messageInput" placeholder="Send test message" required autocomplete="off" />
    <button type="submit" id="sendBtn">Send</button>
    <button type="button" id="clearBtn" title="Clear all messages">Clear Messages</button>
</form>

<div id="status"></div>
<p>Total Messages: <span id="msgCount">0</span></p>

<div id="messagesContainer"></div>

<script>
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messageInput = document.getElementById('messageInput');
    const messagesContainer = document.getElementById('messagesContainer');
    const statusEl = document.getElementById('status');
    const msgCountEl = document.getElementById('msgCount');

    async function fetchMessages() {
        try {
            const res = await fetch('/api/messages'); // JSON API endpoint
            if (!res.ok) throw new Error('Failed to fetch messages');
            const data = await res.json();

            msgCountEl.textContent = data.length;
            messagesContainer.innerHTML = ''; // clear old

            data.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message';
                // Format timestamp HH:mm:ss
               const time = new Date(msg.time);
               const formattedTime = time.toLocaleTimeString();
               div.innerHTML = `<div class="timestamp">${formattedTime}</div><div class="msg-body"></div>`;
               div.querySelector('.msg-body').textContent = msg;
                messagesContainer.appendChild(div);
            });

            // Auto scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            statusEl.textContent = '';
        } catch (err) {
            statusEl.textContent = 'Error loading messages.';
            statusEl.style.color = 'red';
        }
    }

    document.getElementById('messageForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return; // no empty messages

        sendBtn.disabled = true;
        statusEl.style.color = 'green';
        statusEl.textContent = 'Sending message...';

        try {
            const res = await fetch('/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `message=${encodeURIComponent(message)}`
            });
            if (!res.ok) throw new Error('Send failed');

            messageInput.value = '';
            statusEl.textContent = 'Message sent!';
            fetchMessages();
        } catch (err) {
            statusEl.textContent = 'Failed to send message.';
            statusEl.style.color = 'red';
        } finally {
            sendBtn.disabled = false;
            messageInput.focus();
        }
    });

    clearBtn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to clear all messages?')) return;

        try {
            const res = await fetch('/api/messages/clear', { method: 'POST' });
            if (!res.ok) throw new Error('Failed to clear messages');
            statusEl.style.color = 'green';
            statusEl.textContent = 'Messages cleared.';
            fetchMessages();
        } catch {
            statusEl.textContent = 'Failed to clear messages.';
            statusEl.style.color = 'red';
        }
    });

    // Poll every 5 seconds
    setInterval(fetchMessages, 5000);
    fetchMessages(); // initial load
</script>
</body>
</html>
